<!doctype html>
<html>
  <head>
    <link href="calculator.css" rel="stylesheet" />
    <script>
      function clampNum(v, min, max) {
        if (!Number.isFinite(v)) return NaN;
        return Math.min(Math.max(v, min), max);
      }

      function calculator(form) {
        const a = clampNum(Number(form.a.value), 500, 100000) || 0;
        const b = clampNum(Number(form.b.value), -50, 40) || 0;
        const c = clampNum(Number(form.c.value), -20, 80) || 0;
        const d = ((a * (353 / (273.15 + b))) / 3600000) * 1009 * (c - b);
        form.total.value = d.toFixed(1);
      }

      document.addEventListener("DOMContentLoaded", function () {
        const form = document.querySelector("form.calculator");
        if (!form) return;
        const inputs = form.querySelectorAll('input[type="text"]');

        function toggleHasValue(el) {
          if (el.value && el.value.trim() !== "") el.classList.add("has-value");
          else el.classList.remove("has-value");
        }

        inputs.forEach((input) => {
          // initial state
          toggleHasValue(input);
          // keep only digits and one decimal point while typing
          input.addEventListener("input", () => {
            const before = input.value;
            // allow only 0-9 and dot
            let v = before.replace(/[^-0-9.]/g, "");
            // keep only first dot
            const firstDot = v.indexOf(".");
            if (firstDot !== -1) {
              v =
                v.slice(0, firstDot + 1) +
                v.slice(firstDot + 1).replace(/\./g, "");
            }
            if (v !== before) input.value = v;
            toggleHasValue(input);
          });

          // clamp to data-min/data-max on blur (and ensure one decimal)
          input.addEventListener("blur", () => {
            // keep empty fields empty (don't coerce "" -> 0)
            if (!input.value || input.value.trim() === "") {
              input.value = "";
              toggleHasValue(input);
              return;
            }

            const min = Number(input.dataset.min ?? NaN);
            const max = Number(input.dataset.max ?? NaN);
            const n = Number(input.value);
            if (!Number.isFinite(n)) {
              // clear invalid entry
              input.value = "";
              toggleHasValue(input);
              return;
            }
            if (Number.isFinite(min) && Number.isFinite(max)) {
              const clamped = clampNum(n, min, max);
              // format with at most one decimal place (matches calculator output)
              input.value = (Math.round(clamped * 10) / 10).toString();
            }
            toggleHasValue(input);
          });
        });

        // clear highlights on form reset
        const resetBtn = form.querySelector('input[type="reset"]');
        if (resetBtn) {
          resetBtn.addEventListener("click", () => {
            inputs.forEach((i) => i.classList.remove("has-value"));
          });
        }
      });
    </script>
  </head>

  <body>
    <!-- Калькулятор (начало) -->
    <form class="calculator">
      <label>
        Объем нагреваемого воздуха, м³/ч
        <input type="text" name="a" data-min="500" data-max="100000" />
      </label>

      <label>
        Температура входящего воздуха, °С
        <input type="text" name="b" data-min="-50" data-max="40" />
      </label>

      <label>
        Температура выходящего воздуха, °С
        <input type="text" name="c" data-min="-20" data-max="80" />
      </label>

      <div class="calculator-buttons">
        <input
          type="button"
          value="Рассчитать"
          onclick="calculator(this.form)"
        />
        <input type="reset" value="Сброс" />
      </div>

      <label>
        Требуемая мощность калорифера, кВт
        <input type="text" name="total" disabled class="bg-transparent" />
      </label>
    </form>
    <!-- Калькулятор (конец) -->
  </body>
</html>
