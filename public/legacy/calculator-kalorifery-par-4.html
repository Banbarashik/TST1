<!doctype html>
<html>
  <head>
    <link href="calculator.css" rel="stylesheet" />
    <script>
      function clampNum(v, min, max) {
        if (!Number.isFinite(v)) return NaN;
        return Math.min(Math.max(v, min), max);
      }

      function calculator(form) {
        const e = clampNum(Number(form.e.value), 10, 2000) || 0;
        const f = Number(form.f.value);
        const j = ((e / 3600) * f) / 1000;
        form.total.value = j.toFixed(0);
      }

      document.addEventListener("DOMContentLoaded", function () {
        const form = document.querySelector("form.calculator");
        if (!form) return;
        const inputs = form.querySelectorAll('input[type="text"]');

        function toggleHasValue(el) {
          if (el.value && el.value.trim() !== "") el.classList.add("has-value");
          else el.classList.remove("has-value");
        }

        inputs.forEach((input) => {
          // initial state
          toggleHasValue(input);
          // keep only digits and one decimal point while typing
          input.addEventListener("input", () => {
            const before = input.value;
            // allow only 0-9 and dot
            let v = before.replace(/[^-0-9.]/g, "");
            // keep only first dot
            const firstDot = v.indexOf(".");
            if (firstDot !== -1) {
              v =
                v.slice(0, firstDot + 1) +
                v.slice(firstDot + 1).replace(/\./g, "");
            }
            if (v !== before) input.value = v;
            toggleHasValue(input);
          });

          // clamp to data-min/data-max on blur (and ensure one decimal)
          input.addEventListener("blur", () => {
            // keep empty fields empty (don't coerce "" -> 0)
            if (!input.value || input.value.trim() === "") {
              input.value = "";
              toggleHasValue(input);
              return;
            }

            const min = Number(input.dataset.min ?? NaN);
            const max = Number(input.dataset.max ?? NaN);
            const n = Number(input.value);
            if (!Number.isFinite(n)) {
              // clear invalid entry
              input.value = "";
              toggleHasValue(input);
              return;
            }
            if (Number.isFinite(min) && Number.isFinite(max)) {
              const clamped = clampNum(n, min, max);
              // format with at most one decimal place (matches calculator output)
              input.value = (Math.round(clamped * 10) / 10).toString();
            }
            toggleHasValue(input);
          });
        });

        // clear highlights on form reset
        const resetBtn = form.querySelector('input[type="reset"]');
        if (resetBtn) {
          resetBtn.addEventListener("click", () => {
            inputs.forEach((i) => i.classList.remove("has-value"));
          });
        }
      });
    </script>
  </head>

  <body>
    <!-- Калькулятор (начало) -->
    <form class="calculator">
      <label style="margin-bottom: 10px">
        Расход пара, кг/час
        <input type="text" name="e" data-min="10" data-max="2000" />
      </label>

      Давление сухого насыщенного пара, МПа
      <select name="f" size="1" class="steam-pressure">
        <option selected="selected" value="2257510">0.1</option>
        <option value="2201560">0.2</option>
        <option value="2163440">0.3</option>
        <option value="2133330">0.4</option>
        <option value="2107920">0.5</option>
        <option value="2085640">0.6</option>
        <option value="2065610">0.7</option>
        <option value="2047290">0.8</option>
        <option value="2030310">0.9</option>
        <option value="2014440">1.0</option>
        <option value="1999470">1.1</option>
        <option value="1985270">1.2</option>
      </select>

      <div class="calculator-buttons" style="margin-bottom: 15px">
        <input
          type="button"
          value="Рассчитать"
          onclick="calculator(this.form)"
        />
        <input type="reset" value="Сброс" />
      </div>

      <label>
        Тепловая мощность, кВт
        <input type="text" name="total" disabled class="bg-transparent" />
      </label>
    </form>
    <!-- Калькулятор (конец) -->
  </body>
</html>
